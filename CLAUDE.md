# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Umbrella is a multi-module Maven project that integrates observability/monitoring capabilities with web frameworks. The project generates client libraries from an OpenAPI specification and provides integration modules for Java (Tomcat) and TypeScript (Express) frameworks.

## Build System

This is a hybrid Maven/Node.js project:
- Maven coordinates the overall build (Java modules, code generation, testing)
- Node.js/pnpm handles TypeScript builds and OpenAPI schema processing
- The `frontend-maven-plugin` bridges Maven and Node.js tooling

### Key Build Commands

**Full build and test:**
```bash
mvn clean install
```

**Build without tests:**
```bash
mvn clean install -DskipTests
```

**Run tests only:**
```bash
mvn test
```

**Deploy (publish artifacts):**
```bash
mvn clean deploy -P<environment>
# Where environment is: staging or production
```

**Clean everything (including node modules):**
```bash
mvn clean
```

### Module-Specific Commands

**Build umbrella-api (generates JSON schemas from OpenAPI):**
```bash
cd umbrella-api
mvn clean install
# Or directly run the schema generation:
pnpm run generate-json-schema
```

**Build TypeScript base client:**
```bash
cd umbrella-base/umbrella-typescript
mvn clean install
# This generates TypeScript client from OpenAPI, then builds with pnpm
```

## Project Structure

```
umbrella/
├── umbrella-api/              # OpenAPI specification and schema generation
│   ├── src/main/openapi/      # umbrella-api.yaml (source of truth)
│   └── src/main/javascript/   # Schema generation scripts
├── umbrella-base/             # Base client libraries (framework-agnostic)
│   ├── umbrella-java/         # Base Java client
│   └── umbrella-typescript/   # TypeScript client library
├── umbrella-integration/      # Web server integration libraries
│   ├── umbrella-tomcat/       # Tomcat Jakarta integration (Java 11+)
│   ├── umbrella-tomcat-javax/ # Tomcat javax integration (legacy)
│   └── umbrella-express/      # Express.js integration
└── umbrella-stream/           # Stream processing (DataSpray)
    ├── common/                # Shared stream utilities
    ├── controller/            # Control plane functions
    ├── ingester/              # Data ingestion functions
    └── schema/                # DataSpray schemas
```

## Architecture

### Client Architecture

Umbrella uses a two-tier client architecture:
- **Base Client**: Language-specific HTTP client (umbrella-java, umbrella-typescript)
- **Web Server Integration**: Framework-specific middleware/filter (umbrella-tomcat, umbrella-express)

For detailed client architecture, implementation requirements, and extension guide, see [CLIENT-ARCHITECTURE.md](CLIENT-ARCHITECTURE.md).

### API-First Design

The OpenAPI spec at `umbrella-api/src/main/openapi/umbrella-api.yaml` is the single source of truth. Client code is generated from this specification:
- TypeScript client: Generated by `openapi-generator-maven-plugin` using `typescript-fetch` generator
- Java client: Generated using OpenAPI generator for Java

### Base Client Modules

**umbrella-java** (`io.dataspray.umbrella.base:umbrella-java`): Core Java client with HTTP communication logic
**umbrella-typescript** (`io.dataspray.umbrella.base:umbrella-typescript`): TypeScript client with fetch-based HTTP

### Integration Modules

**umbrella-tomcat** (`io.dataspray.umbrella.integration:umbrella-tomcat`): Jakarta Servlet API integration (Java 11+, current standard)
**umbrella-tomcat-javax** (`io.dataspray.umbrella.integration:umbrella-tomcat-javax`): Legacy javax.servlet integration for older apps
**umbrella-express** (`io.dataspray.umbrella.integration:umbrella-express`): Express.js middleware integration (planned)

### Stream Processing (umbrella-stream)

Built with DataSpray (dst CLI tool):
- **ingester**: Handles incoming HTTP events and custom events via queue
- **controller**: Manages organizations, API keys, and rules
- **Architecture diagram**: See `umbrella-stream/ARCHITECTURE.md` for Mermaid diagram

## Development Workflow

### Working with OpenAPI Specs

1. Edit `umbrella-api/src/main/openapi/umbrella-api.yaml`
2. Regenerate schemas: `cd umbrella-api && mvn clean install`
3. Regenerate clients: Build base client modules (e.g., `cd umbrella-base/umbrella-typescript && mvn clean install`)

### Testing

Java tests use JUnit 5 and Mockito:
```bash
# Run all tests
mvn test

# Run tests in specific module
cd umbrella-integration/umbrella-tomcat
mvn test

# Run single test class
mvn test -Dtest=ClassName
```

### Version Management

- Java version: 21 (defined in parent pom.xml)
- Node version: v22.17.0 (see `.nvmrc`, `.node-version`)
- Integration modules may use Java 11 for broader compatibility

## Tool Requirements

- **Java**: 21 (enforced by maven-enforcer-plugin)
- **Node.js**: v22.17.0 (managed by frontend-maven-plugin or use nvm/asdf)
- **Maven**: 3.x
- **pnpm**: v8.6.10
- **dst**: DataSpray CLI (for stream module development)

Version managers:
- Node: Use `.nvmrc` with nvm, or `.node-version` with asdf
- Java: Use `.sdkmanrc` with sdkman or `.tool-versions` with asdf

## Publishing

Artifacts are published to Maven Central (Sonatype OSSRH) and npm:
- Maven artifacts: Published via `nexus-staging-maven-plugin`
- npm packages: Published from TypeScript modules during Maven deploy phase
- All artifacts are GPG signed
- The `exists-maven-plugin` prevents duplicate deployments

## CI/CD

GitHub Actions workflows:
- **test.yml**: Runs `mvn clean install` on push/PR to master
- **deploy.yml**: Deploys to staging/production, publishes artifacts

Both workflows require:
- Java 21
- Node.js (from .nvmrc)
- dst CLI (DataSpray tool via asdf)

## Git Configuration

Commits must be GPG-signed. Configure git before committing:
```bash
git config user.name 'Matus Faro'
git config user.email 'matus@matus.io'
git config commit.gpgsign true
git config user.signingkey matus@matus.io
```
